name: Security Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  semgrep:
    name: Semgrep Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install Semgrep
        run: pip install semgrep
      
      - name: Run Semgrep scan
        run: semgrep scan --config auto --json --output semgrep-results.json src/vulnerable_tasks/
        continue-on-error: true
      
      - name: Display results summary
        if: always()
        run: |
          set -euo pipefail
          [ -f semgrep-results.json ] || exit 0
          
          TOTAL=$(jq '.results | length' semgrep-results.json)
          echo "ðŸ“Š Semgrep Scan Complete"
          echo "Total findings: $TOTAL"
          echo ""
          echo "Findings by severity:"
          jq -r '.results | group_by(.extra.severity) | .[] | "\(.[0].extra.severity): \(length)"' semgrep-results.json
      
      - name: Generate comment
        if: always() && github.event_name == 'pull_request'
        run: |
          set -euo pipefail
          
          if [ ! -f semgrep-results.json ]; then
            {
              echo "## Semgrep Security Scan Results"
              echo ""
              echo "**Scan failed or no results file generated.**"
              echo ""
              echo "Please check the workflow logs for details."
              echo ""
              echo "<!-- AI-SECURITY-FINDINGS -->"
            } > comment.md
            exit 0
          fi
          
          TOTAL=$(jq '.results | length' semgrep-results.json)
          
          if [ "$TOTAL" -eq 0 ]; then
            {
              echo "## Semgrep Security Scan Results"
              echo ""
              echo "**Total findings**: 0"
              echo ""
              echo "No security issues found."
              echo ""
              echo "Full JSON results are available in the workflow artifacts."
              echo ""
              echo "<!-- AI-SECURITY-FINDINGS -->"
            } > comment.md
          else
            SEVERITY_BREAKDOWN=$(jq -r '.results | group_by(.extra.severity) | .[] | "- **\(.[0].extra.severity)**: \(length)"' semgrep-results.json || echo "- No severity data available")
            TOP_FINDINGS=$(jq -r '.results[0:10] | .[] | "- **\(.check_id)** - `\(.path)`:\(.start.line)` - Severity: \(.extra.severity // "unknown")"' semgrep-results.json)
            
            {
              echo "## Semgrep Security Scan Results"
              echo ""
              echo "**Total findings**: $TOTAL"
              echo ""
              echo "### Breakdown by Severity"
              echo "$SEVERITY_BREAKDOWN"
              echo ""
              echo "### First 10 Findings"
              echo "$TOP_FINDINGS"
              echo ""
              echo "> Full JSON results are available in the workflow artifacts."
              echo ""
              echo "<!-- AI-SECURITY-FINDINGS -->"
            } > comment.md
          fi
      
      - name: Post PR comment
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const commentBody = fs.readFileSync('comment.md', 'utf8');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: commentBody
            });
      
      - name: Upload Semgrep results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-results
          path: semgrep-results.json
          retention-days: 30