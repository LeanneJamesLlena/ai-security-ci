name: Security Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  semgrep:
    name: Semgrep Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          pip install "semgrep==1.95.0"
      
      - name: Run Semgrep scan
        run: semgrep scan --config .semgrep/rules.yml --json --output semgrep-results.json src/vulnerable_tasks/
        continue-on-error: true
      
      - name: Validate scan results
        if: always()
        run: |
          set -euo pipefail
          [ -f semgrep-results.json ] || exit 0
          
          FINDINGS=$(jq '.results | length' semgrep-results.json)
          
          if [ "$FINDINGS" -eq 0 ]; then
            echo "‚ö†Ô∏è Warning: No findings detected. Rules may be misconfigured."
          elif [ "$FINDINGS" -gt 15 ]; then
            echo "‚ö†Ô∏è Warning: $FINDINGS findings detected. Rules may be too noisy."
          else
            echo "‚úì Validation passed: $FINDINGS findings detected (expected 5-8)."
          fi
      
      - name: Display results summary
        if: always()
        run: |
          set -euo pipefail
          [ -f semgrep-results.json ] || exit 0
          
          TOTAL=$(jq '.results | length' semgrep-results.json)
          echo "üìä Semgrep Scan Complete"
          echo "Total findings: $TOTAL"
          echo ""
          echo "Findings by severity:"
          jq -r '.results | group_by(.extra.severity) | .[] | "\(.[0].extra.severity): \(length)"' semgrep-results.json
      
      - name: Generate comment
        if: always() && github.event_name == 'pull_request'
        run: |
          set -euo pipefail
          
          if [ ! -f semgrep-results.json ]; then
            {
              echo "## üîí Semgrep Security Scan Results"
              echo ""
              echo "**Scan failed or no results file generated.**"
              echo ""
              echo "Please check the workflow logs for details."
              echo ""
              echo "<!-- AI-SECURITY-FINDINGS -->"
            } > comment.md
            exit 0
          fi
          
          TOTAL=$(jq '.results | length' semgrep-results.json)
          
          if [ "$TOTAL" -eq 0 ]; then
            {
              echo "## üîí Semgrep Security Scan Results"
              echo ""
              echo "**Total findings**: 0"
              echo ""
              echo "No security issues found."
              echo ""
              echo "üì¶ Full results available as workflow artifact: \`semgrep-results.json\`"
              echo ""
              echo "<!-- AI-SECURITY-FINDINGS -->"
            } > comment.md
          else
            ERROR_COUNT=$(jq '[.results[] | select(.extra.severity == "ERROR")] | length' semgrep-results.json)
            WARNING_COUNT=$(jq '[.results[] | select(.extra.severity == "WARNING")] | length' semgrep-results.json)
            INFO_COUNT=$(jq '[.results[] | select(.extra.severity == "INFO")] | length' semgrep-results.json)
            
            SEVERITY_BREAKDOWN=""
            [ "$ERROR_COUNT" -gt 0 ] && SEVERITY_BREAKDOWN="${SEVERITY_BREAKDOWN}- **ERROR**: $ERROR_COUNT"$'\n'
            [ "$WARNING_COUNT" -gt 0 ] && SEVERITY_BREAKDOWN="${SEVERITY_BREAKDOWN}- **WARNING**: $WARNING_COUNT"$'\n'
            [ "$INFO_COUNT" -gt 0 ] && SEVERITY_BREAKDOWN="${SEVERITY_BREAKDOWN}- **INFO**: $INFO_COUNT"$'\n'
            [ -z "$SEVERITY_BREAKDOWN" ] && SEVERITY_BREAKDOWN="- No severity data available"$'\n'
            
            jq -r '.results | 
              map(. + {severity_order: (if .extra.severity == "ERROR" then 0 elif .extra.severity == "WARNING" then 1 elif .extra.severity == "INFO" then 2 else 3 end)}) | 
              sort_by(.severity_order, .path, .start.line) | 
              .[0:10] | 
              .[] | 
              "**\(.check_id)** ‚Äî `\(.path):\(.start.line)` ‚Äî \(.extra.message) _(Severity: \(.extra.severity // "unknown"))_"' \
              semgrep-results.json > findings_list.txt
            
            {
              echo "## üîí Semgrep Security Scan Results"
              echo ""
              echo "**Total findings**: $TOTAL"
              echo ""
              echo "### Breakdown by Severity"
              echo -n "$SEVERITY_BREAKDOWN"
              echo "### Findings"
              cat findings_list.txt
              echo ""
              echo "üì¶ Full results available as workflow artifact: \`semgrep-results.json\`"
              echo ""
              echo "<!-- AI-SECURITY-FINDINGS -->"
            } > comment.md
          fi
      
      - name: Post PR comment
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const commentBody = fs.readFileSync('comment.md', 'utf8');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: commentBody
            });
      
      - name: Upload Semgrep results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-results
          path: semgrep-results.json
          retention-days: 30